from fastapi import FastAPI, UploadFile, File, Form
from fastapi.responses import JSONResponse
from pathlib import Path
from .ingestion import ingest_file
from .agents import QueryAnalyzerAgent, RetrievalAgent, AnswerAgent
from .utils import ensure_dir
import shutil
import uuid

app = FastAPI(title='AI Analyst MVP')

UPLOAD_DIR = Path(__file__).parent.parent / 'uploads'
ensure_dir(UPLOAD_DIR)

analyzer = QueryAnalyzerAgent()
retriever = RetrievalAgent()
answer_agent = AnswerAgent()

@app.post('/upload')
async def upload(file: UploadFile = File(...)):
    dest = UPLOAD_DIR / f"{uuid.uuid4().hex}_{file.filename}"
    with open(dest, 'wb') as f:
        shutil.copyfileobj(file.file, f)
    count = ingest_file(dest, doc_id=dest.stem)
    return JSONResponse({'status':'ok','chunks_created': count, 'filename': dest.name})

@app.post('/query')
async def query_endpoint(question: str = Form(...)):
    plan = analyzer.analyze(question)
    result = retriever.execute(plan)
    chunks = result['chunks']
    ans = answer_agent.answer(question, chunks)
    return JSONResponse({
        'plan': plan,
        'retrieval': result,
        'answer': ans
    })
